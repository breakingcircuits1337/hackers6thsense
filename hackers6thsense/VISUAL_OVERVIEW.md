# Security Implementation - Visual Overview

## ğŸ—ï¸ Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENT REQUEST                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      bootstrap.php                                   â”‚
â”‚  âœ… Security Headers (6)                                            â”‚
â”‚  âœ… CORS Validation                                                 â”‚
â”‚  âœ… Authentication Enforcement                                      â”‚
â”‚  âœ… Error Handlers                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                 â”‚
                    â–¼                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  AuthMiddleware      â”‚  â”‚  Unauthenticated?    â”‚
        â”‚  âœ… Token Validation â”‚  â”‚  Return 401          â”‚
        â”‚  âœ… CORS Check       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼ (Authenticated)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Router.dispatch()                               â”‚
â”‚  Maps URL to Endpoint Handler                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Endpoint Handler                                  â”‚
â”‚  (AnalysisEndpoint, LogEndpoint, etc.)                              â”‚
â”‚                                                                     â”‚
â”‚  1. Validator.clearErrors()                                        â”‚
â”‚  2. Validate each parameter                                        â”‚
â”‚     âœ… validateFilter()                                            â”‚
â”‚     âœ… validateInteger()                                           â”‚
â”‚     âœ… validateQuery()                                             â”‚
â”‚  3. Check Validator.hasErrors()                                    â”‚
â”‚  4. Process request / call analyzer                                â”‚
â”‚  5. Return response                                                â”‚
â”‚                                                                     â”‚
â”‚  Exception? â†’ ErrorHandler.handleException()                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                 â”‚
                    â–¼                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   SUCCESS            â”‚  â”‚   ERROR              â”‚
        â”‚                      â”‚  â”‚                      â”‚
        â”‚ {                    â”‚  â”‚ {                    â”‚
        â”‚   success: true,     â”‚  â”‚   error_code: "...", â”‚
        â”‚   data: { ... }      â”‚  â”‚   message: "...",    â”‚
        â”‚ }                    â”‚  â”‚   details: [...]     â”‚
        â”‚                      â”‚  â”‚ }                    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                 â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CLIENT RESPONSE                                   â”‚
â”‚  - Status Code (200, 400, 401, 403, 404, 500, 503)                 â”‚
â”‚  - JSON Response                                                    â”‚
â”‚  - Security Headers                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SECURITY LAYER 1                    â”‚
â”‚              HTTPS/TLS Transport                 â”‚
â”‚  (Implemented at server level, not in code)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SECURITY LAYER 2                    â”‚
â”‚              Security Headers                    â”‚
â”‚  âœ… X-Content-Type-Options: nosniff             â”‚
â”‚  âœ… X-Frame-Options: DENY                       â”‚
â”‚  âœ… X-XSS-Protection: 1; mode=block             â”‚
â”‚  âœ… Strict-Transport-Security: HSTS             â”‚
â”‚  âœ… Content-Security-Policy                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SECURITY LAYER 3                    â”‚
â”‚              CORS Validation                     â”‚
â”‚  âœ… Whitelist check                             â”‚
â”‚  âœ… Origin validation                           â”‚
â”‚  âœ… No wildcard (*) allowed                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SECURITY LAYER 4                    â”‚
â”‚              Authentication                      â”‚
â”‚  âœ… Bearer token required                       â”‚
â”‚  âœ… API key validation                          â”‚
â”‚  âœ… Timing-safe comparison                      â”‚
â”‚  âœ… Public endpoint whitelist                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SECURITY LAYER 5                    â”‚
â”‚              Input Validation                    â”‚
â”‚  âœ… Type validation                             â”‚
â”‚  âœ… Length limits                               â”‚
â”‚  âœ… Character filtering                         â”‚
â”‚  âœ… Enum validation                             â”‚
â”‚  âœ… Range checking                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SECURITY LAYER 6                    â”‚
â”‚              Error Handling                      â”‚
â”‚  âœ… Exception catching                          â”‚
â”‚  âœ… Stack trace hiding                          â”‚
â”‚  âœ… Sanitized responses                         â”‚
â”‚  âœ… Server-side logging                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SECURITY LAYER 7                    â”‚
â”‚              Data Protection                     â”‚
â”‚  âœ… Cache encryption (AES-256-GCM)              â”‚
â”‚  âœ… Credential protection (.env)                â”‚
â”‚  âœ… Sensitive data masking                      â”‚
â”‚  âœ… TTL validation                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Input Validation Flow

```
                    User Input
                       â”‚
                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Validator.clearErrors()    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Call appropriate validator   â”‚
        â”‚ for each parameter           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Type Check                  â”‚
        â”‚  (int, string, bool)         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Length/Range Check          â”‚
        â”‚  (min, max)                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Character Filtering         â”‚
        â”‚  (remove dangerous chars)    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Enum/Whitelist Check        â”‚
        â”‚  (allowed values only)       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Return Validated Value      â”‚
        â”‚  OR Add Error                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Check hasErrors()            â”‚
        â”‚ If yes â†’ Return 400          â”‚
        â”‚ If no  â†’ Continue Processing â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”‘ Security Classes Interaction

```
                    bootstrap.php
                    (Initialization)
                         â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚            â”‚            â”‚
            â–¼            â–¼            â–¼
     AuthMiddleware  ErrorHandler  Config
     (Auth & CORS)  (Error Fmt)   (Secrets)
            â”‚            â”‚            â”‚
            â”‚            â”‚            â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                    Endpoints
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                â”‚                â”‚
        â–¼                â–¼                â–¼
    Validator         Cache          Logger
   (Input Val)    (Encryption)      (Audit)
```

---

## ğŸ¯ Request Lifecycle

```
1. REQUEST RECEIVED
   â”œâ”€ Check method (GET, POST, etc.)
   â”œâ”€ Parse headers
   â””â”€ Extract body

2. BOOTSTRAP PHASE
   â”œâ”€ Load .env configuration
   â”œâ”€ Initialize Logger
   â”œâ”€ Initialize ErrorHandler
   â”œâ”€ Initialize AuthMiddleware
   â””â”€ Send Security Headers

3. CORS VALIDATION
   â”œâ”€ Get Origin header
   â”œâ”€ Check against ALLOWED_ORIGINS
   â”œâ”€ Send CORS headers (if allowed)
   â””â”€ Reject if origin not allowed

4. AUTHENTICATION
   â”œâ”€ Check if endpoint is public
   â”œâ”€ If not public:
   â”‚  â”œâ”€ Get Authorization header
   â”‚  â”œâ”€ Extract Bearer token
   â”‚  â”œâ”€ Validate against API_KEY
   â”‚  â””â”€ Reject if invalid (401)
   â””â”€ Continue if authenticated

5. ROUTING
   â”œâ”€ Parse request URL
   â”œâ”€ Match against registered routes
   â””â”€ Call appropriate endpoint handler

6. INPUT VALIDATION
   â”œâ”€ Validator.clearErrors()
   â”œâ”€ Validate each parameter
   â”œâ”€ Check for errors
   â””â”€ Reject if validation fails (400)

7. BUSINESS LOGIC
   â”œâ”€ Check cache (encrypted)
   â”œâ”€ Process request
   â”œâ”€ Generate response
   â””â”€ Store in cache (encrypted)

8. RESPONSE
   â”œâ”€ Format response
   â”œâ”€ Set HTTP status
   â”œâ”€ Send JSON
   â””â”€ Include Security Headers

9. ON ERROR
   â”œâ”€ Catch exception
   â”œâ”€ Log full details server-side
   â”œâ”€ Send sanitized response to client
   â””â”€ Return appropriate HTTP status
```

---

## ğŸ’¾ Data Protection Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Sensitive Data        â”‚
â”‚   (API keys, queries)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Should cache?   â”‚
    â”‚                  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
         â”‚         â”‚
         YES       NO
         â”‚         â”‚
         â–¼         â–¼
    Encrypt    In Memory
    (AES-256)  (Volatile)
         â”‚         â”‚
         â–¼         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   SecureCache.set()     â”‚
    â”‚                         â”‚
    â”‚1. Encrypt data         â”‚
    â”‚2. Generate IV          â”‚
    â”‚3. Base64 encode        â”‚
    â”‚4. Add expiration time  â”‚
    â”‚5. Version number       â”‚
    â”‚6. Write to disk        â”‚
    â”‚7. Set perms (0600)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Cache File (Encrypted)â”‚
    â”‚                         â”‚
    â”‚ v1_sha256hash.cache     â”‚
    â”‚ (containing base64      â”‚
    â”‚  encrypted JSON)        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

On Retrieval:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ SecureCache.get()        â”‚
    â”‚                          â”‚
    â”‚ 1. Read file             â”‚
    â”‚ 2. Base64 decode         â”‚
    â”‚ 3. Extract IV            â”‚
    â”‚ 4. Decrypt (AES-256)     â”‚
    â”‚ 5. Check expiration      â”‚
    â”‚ 6. Check version         â”‚
    â”‚ 7. Return value          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Decrypted Data         â”‚
    â”‚   Available to App       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš¨ Error Handling Flowchart

```
                  Exception Thrown
                        â”‚
                        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ ErrorHandler.handleEx() â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                 â”‚
        â–¼                                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Log Server-Side     â”‚   â”‚ Format Client Resp  â”‚
    â”‚                     â”‚   â”‚                     â”‚
    â”‚ Full details:       â”‚   â”‚ Generic message:    â”‚
    â”‚ - Message           â”‚   â”‚ - error_code        â”‚
    â”‚ - File              â”‚   â”‚ - message           â”‚
    â”‚ - Line              â”‚   â”‚ - details (if debug)â”‚
    â”‚ - Stack trace       â”‚   â”‚                     â”‚
    â”‚ - Context           â”‚   â”‚ No exposures:       â”‚
    â”‚ - Timestamp         â”‚   â”‚ - Stack traces      â”‚
    â”‚                     â”‚   â”‚ - File paths        â”‚
    â”‚ â†’ storage/logs/     â”‚   â”‚ - DB queries        â”‚
    â”‚   pfsense-ai.log    â”‚   â”‚                     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚  Set HTTP Status     â”‚
                          â”‚                      â”‚
                          â”‚  400 - Validation    â”‚
                          â”‚  401 - Auth Failed   â”‚
                          â”‚  403 - Forbidden     â”‚
                          â”‚  404 - Not Found     â”‚
                          â”‚  500 - Server Error  â”‚
                          â”‚  503 - Unavailable   â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ Return JSON Response â”‚
                        â”‚ with Error Code      â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ Validator Methods Chain

```
All Parameters
     â”‚
     â”œâ”€â†’ validateTimeframe()
     â”‚   â””â”€â†’ Check against enum
     â”‚       â”œâ”€ last_hour âœ…
     â”‚       â”œâ”€ last_24_hours âœ…
     â”‚       â”œâ”€ last_7_days âœ…
     â”‚       â”œâ”€ last_30_days âœ…
     â”‚       â”œâ”€ custom âœ…
     â”‚       â””â”€ other âŒ â†’ Error
     â”‚
     â”œâ”€â†’ validateInteger()
     â”‚   â”œâ”€â†’ Check type (is int)
     â”‚   â”œâ”€â†’ Check min bound
     â”‚   â”œâ”€â†’ Check max bound
     â”‚   â””â”€â†’ Return or Error
     â”‚
     â”œâ”€â†’ validateFilter()
     â”‚   â”œâ”€â†’ Check length (â‰¤ 500)
     â”‚   â”œâ”€â†’ Remove bad chars
     â”‚   â”œâ”€â†’ Allow operators
     â”‚   â””â”€â†’ Return sanitized
     â”‚
     â”œâ”€â†’ validateQuery()
     â”‚   â”œâ”€â†’ Check length (â‰¤ 1000)
     â”‚   â”œâ”€â†’ Remove dangerous chars
     â”‚   â”œâ”€â†’ Keep punctuation
     â”‚   â””â”€â†’ Return sanitized
     â”‚
     â”œâ”€â†’ validateIp()
     â”‚   â””â”€â†’ FILTER_VALIDATE_IP
     â”‚       â”œâ”€ Valid IPv4 âœ…
     â”‚       â”œâ”€ Valid IPv6 âœ…
     â”‚       â””â”€ Invalid âŒ â†’ Error
     â”‚
     â”œâ”€â†’ validatePort()
     â”‚   â”œâ”€â†’ Check type (is int)
     â”‚   â”œâ”€â†’ Check range (1-65535)
     â”‚   â””â”€â†’ Return or Error
     â”‚
     â””â”€â†’ hasErrors()
         â”œâ”€ Yes? â†’ handleValidationError()
         â””â”€ No?  â†’ Continue Processing
```

---

## ğŸ”— API Request Example Flow

```
REQUEST:
    POST /api/logs
    Authorization: Bearer abc123def456...
    Content-Type: application/json
    
    {
        "filter": "src:192.168.1.100",
        "limit": "50",
        "offset": "0"
    }

PROCESSING:
    bootstrap.php
    â”œâ”€ Load .env
    â”œâ”€ Set security headers
    â””â”€ Initialize AuthMiddleware
    
    AuthMiddleware
    â”œâ”€ Check Origin header
    â”œâ”€ Validate CORS
    â””â”€ Validate Bearer token â†’ OK
    
    Router
    â”œâ”€ Match POST /api/logs
    â””â”€ Call LogEndpoint::getLogs()
    
    LogEndpoint::getLogs()
    â”œâ”€ Validator.clearErrors()
    â”œâ”€ Validate filter
    â”‚  â””â”€ Check length, remove bad chars
    â”‚      Result: "src:192.168.1.100" âœ…
    â”œâ”€ Validate limit (50)
    â”‚  â””â”€ Check type, range (1-1000)
    â”‚      Result: 50 âœ…
    â”œâ”€ Validate offset (0)
    â”‚  â””â”€ Check type (â‰¥ 0)
    â”‚      Result: 0 âœ…
    â”œâ”€ Check hasErrors() â†’ No
    â”œâ”€ Call LogAnalyzer.analyzeLogs()
    â””â”€ Get results
    
    Response
    â”œâ”€ Set status: 200
    â”œâ”€ Add security headers
    â””â”€ Send:
    {
        "success": true,
        "data": {
            "logs": [...],
            "count": 50
        }
    }

HEADERS SENT:
    â”œâ”€ X-Content-Type-Options: nosniff
    â”œâ”€ X-Frame-Options: DENY
    â”œâ”€ X-XSS-Protection: 1; mode=block
    â”œâ”€ Strict-Transport-Security: max-age=31536000
    â”œâ”€ Content-Security-Policy: default-src 'self'
    â”œâ”€ Access-Control-Allow-Origin: http://localhost:3000
    â””â”€ Content-Type: application/json; charset=utf-8
```

---

## ğŸ“Š Comparison: Before vs After

```
BEFORE          â”‚  AFTER
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
No auth         â”‚  Bearer token required
Wildcard CORS   â”‚  Whitelist CORS
No validation   â”‚  10+ validators
Stack traces    â”‚  Error codes only
Plaintext cache â”‚  AES-256-GCM encrypted
MD5 hashes      â”‚  SHA256 + versioning
No headers      â”‚  6 security headers
Inconsistent    â”‚  Standardized responses
errors          â”‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
INSECURE        â”‚  PRODUCTION READY
```

---

This visual overview helps understand how all the security components work together to protect the application.
